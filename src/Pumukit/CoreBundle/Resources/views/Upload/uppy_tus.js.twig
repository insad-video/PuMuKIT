const uppyTUS = Uppy.Core({
        debug: false,
        autoProceed: true,
        restrictions: {
            maxFileSize: convertSizeToBytes("{{ php_upload_max_filesize() }}"),
            allowedFileTypes: ['audio/*','video/*']
        },
        onBeforeFileAdded:  (currentFile) => {
            currentFile.name = `${Date.now()}_${currentFile.name}`;
        }
    })
    .use(Uppy.Dashboard, {
        target: '#uploader_drag_and_drop',
        inline: true
    })
    .use(Uppy.Tus, {
        endpoint: "{{ inboxUploadURL }}",
        limit: {{ inboxUploadLIMIT }}
    })
    .run()

uppyTUS.on('upload-success', (file, response) => {
    uppyTUS.setFileState(file.id, { uploadURL: `${response.url}/get` })
    sendXHRImportRequest(file);
})

function convertSizeToBytes(size)
{
    if(size.indexOf('GB') !== -1) {
        return parseInt(size.replace("GB","")) * 1024 * 1024 * 1024;
    }

    if(size.indexOf('MB') !== -1) {
        return parseInt(size.replace("MB","")) * 1024 * 1024;
    }

    return 1024*1024*1024;
}

function sendXHRImportRequest(file)
{
    var xhr = new XMLHttpRequest();
    xhr.open("POST", '/dispatchImport', true);
    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    xhr.send("fileName="+file.name);
}
